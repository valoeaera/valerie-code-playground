---
slug: htb-fuse
title: HTB Fuse Report
authors: val
tags: [htb, pentest]
---

## High Level Summary

Fuse was a Windows Domain Controller machine hosting a web print portal. Because the lab was released before 2020, it is vulnerable to [ZeroLogon (CVE-2020-1472)](https://www.secura.com/blog/zero-logon), but I've performed that attack many times in my other labs, so I'll leave it as an exercise to the reader. On said page, there are a number of usernames which, when combined with a wordlist generated by CeWL, finds an outdated credential pair. This outdated pair can be used to reset the account's password. Using RPC with the new password, credentials for a service account can be found. That service account can log in using WinRM, so a shell can be obtained. The service account has permissions to install device drivers, so a malicious driver can be compiled and installed on the device to spawn a shell as `SYSTEM`.

<!--truncate-->

## Service Enumeration

### Nmap

![](https://storage.googleapis.com/val-roudebush-report-images/htb-pics/fuse/01.png)
![](https://storage.googleapis.com/val-roudebush-report-images/htb-pics/fuse/02.png)

Nmap indicates several ports and information about the machine:

- 53: DNS. Since this is a HTB lab, there's not likely to be anything interesting here. In the real world, this allows you to get a ton of useful information about an organization. If there were fewer other ports open, I'd take a look at this.
- 88: Kerberos. Along with a couple other ports, this means we're dealing with a Windows Domain Controller. If it's old, it's vulnerable to ZeroLogon, so always test that out.
- 135, 139: RPC & NetBIOS
- 389: LDAP. Another port that indicates that this is a domain controller. This leaks the domain name as well: `fabricorp.local`
- 445: SMB. There might be goodies for the taking over SMB file share.
- 464, 593, 636: Kpasswd, RPC over HTTP, and secure LDAP
- 1433: MSSQL. If we get credentials for it, we might be able to get user information or a shell from this. It might also be a hint that a web page is SQL-injectable.
- 3268 & 3269: More LDAP ports
- 8080: HTTP. There's a web page here too. Web pages often have a lot of different attack vectors, so this is very interesting.
- 49XXX ports: RPC ports

### Web Enumeration

Trying to go to `http://10.129.2.5` redirects to `fuse.fabricorp.local`, which my machine can't find.

![](https://storage.googleapis.com/val-roudebush-report-images/htb-pics/fuse/03.png)

I can edit my `/etc/resolv.conf` so that my machine uses the target for DNS (port 53 is open).

![](https://storage.googleapis.com/val-roudebush-report-images/htb-pics/fuse/04.png)

Once I've done this, I get a print logger on HTTP. Most of the page seems to be static content, with hard-coded pages, so no parameters to mess with.

![](https://storage.googleapis.com/val-roudebush-report-images/htb-pics/fuse/05.png)

There are a bunch of print jobs. I can't see what was printed, but I can see a bunch of usernames.

![](https://storage.googleapis.com/val-roudebush-report-images/htb-pics/fuse/06.png)
![](https://storage.googleapis.com/val-roudebush-report-images/htb-pics/fuse/07.png)
![](https://storage.googleapis.com/val-roudebush-report-images/htb-pics/fuse/08.png)

### Enumeration for Valid Credentials

I manually copied these to a file for use later.

![](https://storage.googleapis.com/val-roudebush-report-images/htb-pics/fuse/09.png)

I want to try to see if these usernames are all valid domain users, so I'll use Kerbrute, which I've used [before](./2022-10-05-HTB-Blackfield.md).

![](https://storage.googleapis.com/val-roudebush-report-images/htb-pics/fuse/10.png)

All five are valid. In hindsight, I should have added a known-bogus username to verify that it's not just returning everything up. Here I use `cewl` to generate a wordlist for potential passwords. Then I can feed those two lists to `crackmapexec` to spray those credentials pairs.

![](https://storage.googleapis.com/val-roudebush-report-images/htb-pics/fuse/11.png)
![](https://storage.googleapis.com/val-roudebush-report-images/htb-pics/fuse/12.png)

I get `tlavel:Fabricorp01`, but it's status of `PASSWORD_MUST_CHANGE`, which means it was valid in the past, but now it's not. We can still use it though.

## Initial Foothold

### Password Reset to Enumerate More Users

![](https://storage.googleapis.com/val-roudebush-report-images/htb-pics/fuse/13.png)

Using `smbpasswd`, I can use the old password to reset this user's password. I had to do some trial-and-error to figure out the password rules. It turns out that there is a script that goes and sets the password back to `Fabricorp01` every minute or so. So every time I run a different command, I'm running this reset every time and incrementing the number by 1 due to password history.

![](https://storage.googleapis.com/val-roudebush-report-images/htb-pics/fuse/14.png)

There is a printer user, as expected from the print logging service.

![](https://storage.googleapis.com/val-roudebush-report-images/htb-pics/fuse/15.png)

Enumerating the printers yields a password from the description field. I have to use an IP for this command due to a bug in `rpcclient`. Using this password, I can see that the service user has WinRM access, which is pretty neat.

![](https://storage.googleapis.com/val-roudebush-report-images/htb-pics/fuse/16.png)

Evil-WinRM allows me to get a shell and the user flag.

![](https://storage.googleapis.com/val-roudebush-report-images/htb-pics/fuse/17.png)

## Privilege Escalation

### WinPEAS

I want to run winPEAS on the box to enumerate for privilege escalation vectors, so I host the binary out of my tools directory.

![](https://storage.googleapis.com/val-roudebush-report-images/htb-pics/fuse/18.png)

Then I download the binary on the target and run it.

![](https://storage.googleapis.com/val-roudebush-report-images/htb-pics/fuse/19.png)

WinPEAS doesn't mark it red, but under `Users`, I can see that I have the `SeLoadDriverPrivilege`. This means that this account can load and install device drivers. This is done likely for printer drivers, since this is a service account for the printer. But it does allow me to install malicious drivers which will give me root privileges.

![](https://storage.googleapis.com/val-roudebush-report-images/htb-pics/fuse/20.png)

### Capcom.sys, Malicious Device Drivers

I need a few files to execute this exploit. What's more, I need to compile a lot of them on Windows, so I'll need to build all the files I need and send them over to Linux. Here's a list of links to the files I'm using:

- [EoPLoadDriver](https://github.com/TarlogicSecurity/EoPLoadDriver/): Loads the malicious Capcom.sys into the installed drivers
- [Capcom.sys](https://github.com/FuzzySecurity/Capcom-Rootkit/blob/master/Driver/Capcom.sys): The malicious driver we'll be installing
- [ExploitCapcom](https://github.com/tandasat/ExploitCapcom): Uses Capcom.sys to execute a binary, in this case, we'll be generating a reverse shell payload with MSFVenom.

![](https://storage.googleapis.com/val-roudebush-report-images/htb-pics/fuse/21.png)

#### Compiling Some Binaries

In MS Visual Studio, we'll make a blank new C++ project.

![](https://storage.googleapis.com/val-roudebush-report-images/htb-pics/fuse/23.png)

Then, I copied-and-pasted the code from `EoPLoadDriver.cpp` in the Git repository into the new `EoPLoadDriver` in my project. I could have also just deleted the new blank file and moved the old one into its place. Then, I changed the selector in the ribbon to "Release" and "x64" and selected "Build -> Start Build" from the menu to build the binary.

![](https://storage.googleapis.com/val-roudebush-report-images/htb-pics/fuse/24.png)

`ExploitCapcom` is already a Visual Studio project, so I can just open it.

![](https://storage.googleapis.com/val-roudebush-report-images/htb-pics/fuse/25.png)

Now, you'll need to edit the `LaunchShell()` function to point to what will be my reverse shell payload instead of `cmd.exe`. I'll build this project with the same options as `EoPLoadDriver`.

![](https://storage.googleapis.com/val-roudebush-report-images/htb-pics/fuse/26.png)

#### Generating a Reverse Shell Payload

Back on Kali, I can use MSFVenom to create that payload that `ExploitCapcom` points to.

![](https://storage.googleapis.com/val-roudebush-report-images/htb-pics/fuse/27.png)

I also zipped up a folder containing all three of the files from Windows to send it over to Kali. Now I have all the tools I'll need to exploit the target.

![](https://storage.googleapis.com/val-roudebush-report-images/htb-pics/fuse/28.png)

#### Exploitation, Shell as `SYSTEM`

I first start a `nc` listener for my payload to hit against in a new terminal tab.

![](https://storage.googleapis.com/val-roudebush-report-images/htb-pics/fuse/29.png)

On my WinRM shell, I can use `upload` to simply upload each file to the target. Now all of the tools are on the target.

![](https://storage.googleapis.com/val-roudebush-report-images/htb-pics/fuse/30.png)

I'll use `EoPLoadDriver` to load `Capcom.sys`. `NTSTATUS: 00000000` means that the service is running.

![](https://storage.googleapis.com/val-roudebush-report-images/htb-pics/fuse/31.png)

Then, I'll use `ExploitCapom` to run `valoe.exe` with `Capcom.sys`.

![](https://storage.googleapis.com/val-roudebush-report-images/htb-pics/fuse/32.png)

And I get a `SYSTEM` shell on my listener and can grab the root flag.

![](https://storage.googleapis.com/val-roudebush-report-images/htb-pics/fuse/33.png)

## Recommendations

- Insufficient Password
  - The `tlavel` user's password was easily guessable (`hashcat` generates it as one of the first options when fed the name of the domain) and was even used as a filename for a job in the print queue. This is not `sthompson`, the user who submitted the job in question, at fault, but it is evidence of its insecurity
  - It is my recommendation that this user be required to change their password and a stricter password policy be implemented to prevent easily guessable passwords from being used.
- Remote Password Reset
  - I was able to reset `tlavel`'s password remotely, even though I only had the expired password. This is because of an SMB misconfiguration. The method I used in my exploitation requires that anonymous access to the `$IPC` share be available.
  - It is my recommendation that this, along with any other anonymous SMB access, should be disabled.
- Reused & Plaintext Password
  - The service account's password was both reused (also used as the password for scan2docs) and stored in plaintext in the printer description. With Windows service accounts, it is very important to harden and ensure the security of these accounts as they inherently have access to sensitive system functions, like installing device drivers. Any attacker with access to one of these accounts is often times only a couple steps removed from full system control.
  - It is my recommendation that this password be removed from the description and one (or preferably both) of the passwords be changed to avoid reuse in this way.
